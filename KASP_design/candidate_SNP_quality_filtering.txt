
#### 1/20/21 ####

1) Filter for biallelic SNPs (no indels) with high enough quality score

bcftools view introgress1.v7.variants.filtertest.vcf --include 'TYPE="snp" & N_ALT=1 & QUAL>998'  --output-type v --output introgress1.v7.variants.candidates.vcf
(this worked)

Redo after rerunning filter to exclude heterozygotes in homozygous classes:
bcftools view introgress1.v7.variants.filtered2.vcf --include 'TYPE="snp" & N_ALT=1 & QUAL>998'  --output-type v --output introgress1.v7.variants.candidates.vcf
(this worked but now the list is much much smaller; may have to go back and redo this to allow more through.)


2) Check that the genotype filters worked by looking at each sample group separately

2.1) output txt file for each sample category and check in excel

# Hom. glaz samples
bcftools view  --samples-file glaziovii.txt  --output-type v  introgress1.v7.variants.candidates.vcf  |  bcftools query -f '%POS\t%INFO/AD[\t%DP]\n' > glazDP.txt

# Het samples
bcftools view  --samples-file bighetrefs.txt   --output-type v  introgress1.v7.variants.candidates.vcf  |  bcftools query -f '%POS\t%INFO/AD[\t%DP]\n' > hetDP.txt


# Hom. esc samples
bcftools view  --samples-file bigescrefs.txt   --output-type v  introgress1.v7.variants.candidates.vcf  |  bcftools query -f '%POS\t%INFO/AD[\t%DP]\n' > escDP.txt


# See which INFO/AD has three columns instead of 2 (should be biallelic)
bcftools view --output-type v  introgress1.v7.variants.candidates.vcf  |  bcftools query -f '%POS %INFO/AD \n' | less
(it's because an extra comma is getting added when AD is four digits; try exporting with different formatting:)

bcftools view  --samples-file glaziovii.txt  --output-type v  introgress1.v7.variants.candidates.vcf  |  bcftools query -f '%POS,%INFO/AD, [ %DP],\n' > glazDPtest.txt
(this works if you import to excel as a comma-separated file. Let's now redo the other txt file exports in this format.)



2.2) Redo output txt file and check in excel:

# Hom. glaz samples
bcftools view  --samples-file glaziovii.txt  --output-type v  introgress1.v7.variants.candidates.vcf  |  bcftools query -f '%POS,%INFO/AD, [ %DP],\n' > glazDP.txt

# Het samples
bcftools view  --samples-file bighetrefs.txt   --output-type v  introgress1.v7.variants.candidates.vcf  |  bcftools query -f '%POS,%INFO/AD, [ %DP],\n' > hetDP.txt


# Hom. esc samples
bcftools view  --samples-file bigescrefs.txt   --output-type v  introgress1.v7.variants.candidates.vcf  |  bcftools query -f '%POS,%INFO/AD, [ %DP],\n' > escDP.txt


# View in less:
bcftools view  --samples-file glaziovii.txt  --output-type v  introgress1.v7.variants.candidates.vcf  |  bcftools query -f '%POS %INFO/DP %INFO/AD [ %AD] \n' | less
(I think the AD is still showing over all of the samples, not just the samples in this subfile. The DP is total DP for both alleles.).




3) Look at DP histogram
See Excel document: DPsummary




4) Decide which samples if any to exclude
- from glaz panel: MglazioviiR has DP=0 everywhere. Definitely exclude. MglazioviiS has total DP=79 across the candidates. Probably exclude.
- from hom. esc panel: Albert has DP=0 everywhere. Exclude.
- all samples in het panel looks okay.

Remove outliers:

bcftools view  --samples-file fullpanel_nooutliers.txt  --output-type v  introgress1.v7.variants.candidates.vcf --output-file introgress1.v7.variants.candidates.nooutliers.vcf





5) Check that the genotype filtering worked by checking group AD:

bcftools view  --samples-file bighetrefs.txt  --output-type v  introgress1.v7.variants.candidates.vcf  |  bcftools query -f '%POS %INFO/AD [ %SAMPLE= %GT %AD] \n' | less -S
(all look good)




6) Filter based on DP score and missingness:

# Practice viewing fields to potentially filter on:
bcftools view  --samples-file bighetrefs.txt  --output-type v  introgress1.v7.variants.candidates.vcf  |  bcftools query -f '%POS %FORMAT/DP  \n' | less -S

bcftools view --exclude 'FORMAT/DP < 2'  --output-type v introgress1.v7.variants.candidates.vcf | bcftools query -f '%POS %INFO/AD [ %SAMPLE= %GT %AD] \n' | less -S
(this doesn't work)

(note: FORMAT/DP is per-sample DP)

bcftools view --include 'F_MISSING < 0.1'  --output-type v introgress1.v7.variants.candidates.vcf | bcftools query -f '%POS %INFO/AD [ %SAMPLE= %GT %AD] \n' | less -S

#Count sites that would pass missingness filter:
bcftools view --include 'F_MISSING < 0.07'  --output-type v introgress1.v7.variants.candidates.nooutliers.vcf | bcftools query -f '%POS\n' | wc -l
(out of 934 sites)
(see missingness_filters_test sheet of DPsummary excel doc)
(go with 10% missingness to retail 414 sites)


bcftools view --include 'F_MISSING < 0.1'  --output-type v --output-file introgress1.v7.variants.candidates.nooutliers.10mis.vcf introgress1.v7.variants.candidates.nooutliers.vcf



bcftools view --exclude 'FORMAT/DP[@glaziovii_nooutliers.txt] < 3'  --output-type v introgress1.v7.variants.candidates.nooutliers.vcf | bcftools query -f '%POS [ %SAMPLE= %GT %AD] \n' | less -S
(it looks like this syntax works, try counting sites to test filter)

bcftools view --exclude 'FORMAT/DP[@glaziovii_nooutliers.txt] < 1'  --output-type v introgress1.v7.variants.candidates.nooutliers.vcf | bcftools query -f '%POS\n' | wc -l
(=276)

Next: try on het panel:
bcftools view --exclude 'FORMAT/DP[@bighetrefs.txt] < 1'  --output-type v introgress1.v7.variants.candidates.nooutliers.vcf | bcftools query -f '%POS\n' | wc -l
(213)

bcftools view --exclude 'FORMAT/DP[@bighetrefs.txt] < 2'  --output-type v introgress1.v7.variants.candidates.nooutliers.vcf | bcftools query -f '%POS\n' | wc -l
(=97)

bcftools view --exclude 'FORMAT/DP[@bighetrefs.txt] < 3'  --output-type v introgress1.v7.variants.candidates.nooutliers.vcf | bcftools query -f '%POS\n' | wc -l
(=9)




bcftools view --include 'F_MISSING < 0.1' --output-type v introgress1.v7.variants.candidates.nooutliers.vcf | bcftools view --exclude 'FORMAT/DP[@bighetrefs.txt] < 2' --output-type v | bcftools query -f '%POS\n' | wc -l
(=87 sites remain, go with this)



bcftools view --include 'F_MISSING < 0.1' --output-type v introgress1.v7.variants.candidates.nooutliers.vcf | bcftools view --exclude 'FORMAT/DP[@bighetrefs.txt] < 2' --output-type v --output-file introgress1.v7.variants.candidates.nooutliers.10mis.2DPhets.vcf
(this looks good but may need to go back to catch some SNPs at the beginning of the introgression region that are lower quality)


Checking where the beginning sites got filtered out:
bcftools view  --output-type v  introgress1.v7.variants.widercandidates.vcf   |  bcftools query -f '%POS \n' | less -S

Count number of sites remaining:
bcftools view --output-type v introgress1.v7.variants.widercandidates.vcf | bcftools query -f '%POS\n' | wc -l 

introgress1.v7.variants.candidates.vcf: starts at POS 27643909; 943 sites
introgress1.v7.variants.vcf: starts at 24000025
introgress1.v7.variants.filtertest.vcf: starts at 24016874; 8992 sites
introgress1.v7.variants.filtered2.vcf: starts at 24016874; 1775 sites

Many earlier sites are lost in the step from 'filtered2' to 'candidates' file which uses these filters: 'TYPE="snp" & N_ALT=1 & QUAL>998.
It is the QUAL>998 filter that excludes the earlier sites.



bcftools view --include 'TYPE="snp" & N_ALT=1' --output-type v --output-file introgress1.v7.variants.widercandidates.vcf  introgress1.v7.variants.filtered2.vcf 

(now there are 1750 sites which start at POS 24016874)

Up Next: apply a unique missingness and DP filter with a lower threshold just for the first sites in 24-27 Mbp region. Will need to check DP scores specific to this region; maybe one of the groups doesn't align well here





#### 1/21/21 ####

Goal: starting with introgress1.v7.variants.widercandidates.vcf, look at quality and DP scores in the 24-27 Mbp region and decide on less stringent filter thresholds.


bcftools view  --samples-file glaziovii.txt  --output-type v  introgress1.v7.variants.widercandidates.vcf  |  bcftools query -f 'POS %POS INFO/AD %INFO/AD [ %SAMPLE= %GT %AD] \n' | less -S
(none of the glazioviis seem to align in the whole region 24-27; the genotypes are almost all missing.)

bcftools view  --samples-file bighetrefs.txt  --output-type v  introgress1.v7.variants.widercandidates.vcf  |  bcftools query -f 'POS %POS INFO/AD %INFO/AD [ %SAMPLE= %GT %AD] \n' | less -S
(very spotty in the hets too. Majority all missing.)

bcftools view  --samples-file bigescrefs.txt  --output-type v  introgress1.v7.variants.widercandidates.vcf  |  bcftools query -f 'POS %POS INFO/AD %INFO/AD [ %SAMPLE= %GT %AD] \n' | less -S
(but also a lot of missingness in the esculentas too. not sure what could be going on there.)

Next: will check the hm3 variants file and see if there is a lot of missingness there too.



Redoing the genotype filter on the hm3.vcf:

bcftools view cassava_hm3_largerpanel_Chr1.recode.vcf --exclude 'GT[@glaziovii.txt]="ref" | GT[@glaziovii.txt]="het" | GT[@bigescrefs.txt]="alt" | GT[@bigescrefs.txt]="het" |GT[@bighetrefs.txt]="hom"'  --output-type v --output cassava_hm3_largerpanel_Chr1.filtered2.vcf

bcftools view cassava_hm3_largerpanel_Chr1.filtered2.vcf --include 'TYPE="snp" & N_ALT=1'  --output-type v --output cassava_hm3_largerpanel_Chr1.filtered2.candidates.vcf

Checking the results:
bcftools view  --samples-file glaziovii.txt  --output-type v  cassava_hm3_largerpanel_Chr1.filtered2.candidates.vcf  |  bcftools query -f 'POS %POS [ %DP] \n' | less -S

Next: check in esc refs and het refs too. Glazioviis are mostly all missing (DP=0) but could maybe scrape a could sites in the 25-26 Mbp region.

bcftools view  --samples-file bighetrefs.txt  --output-type v  cassava_hm3_largerpanel_Chr1.filtered2.candidates.vcf  |  bcftools query -f 'POS %POS [ %DP] \n' | less -S


bcftools view  --samples-file bighetrefs.txt  --output-type v  cassava_hm3_largerpanel_Chr1.filtered2.candidates.vcf  |  bcftools query -f 'POS %POS QUAL %QUAL DP [ %DP] \n' | less -S


Note: if this doesn't work and I can't find good sites in the 24-27 Mbp range, I could try redoing the candidate filtering by somehow requiring that at least ~95% of the samples meet the genotype criteria or something, in case the panel is so big that random mutations/genotype outliers are common enough that it is preventing too many real IDM SNPs from passing through the filter.


Next: try a missingness threshold:

bcftools view --samples-file bighetrefs.txt --include 'F_MISSING < 0.8'  --output-type v cassava_hm3_largerpanel_Chr1.filtered2.candidates.vcf | bcftools query -f 'POS %POS QUAL %QUAL DP [ %DP] \n' | less -S
(I'm not sure F_MISSING is working as I intend, missingness 0.5 only has a handful of sites and missingness 0.8 includes many sites where all DP=0. Maybe it is filtering over everything not just the samples in the samples-file?)

bcftools view --samples-file bighetrefs.txt  --output-type v cassava_hm3_largerpanel_Chr1.filtered2.candidates.vcf | bcftools view --include 'F_MISSING < 2.0' --output-type v | bcftools query -f 'POS %POS QUAL %QUAL DP [ %DP] \n' | less -S
(F_MISSING can go above 1.0 ??)

Try F_PASS:

F_PASS(DP>0) > 0.9


bcftools view --samples-file bighetrefs.txt  --output-type v cassava_hm3_largerpanel_Chr1.filtered2.candidates.vcf | bcftools view --include 'F_PASS(FORMAT/DP>0) > 0.25' --output-type v | bcftools query -f 'POS %POS QUAL %QUAL DP [ %DP] \n' | less -S





#### 1/22/21 ####


GWAS tagged SNP v6: 24159585, 24155070; Dry matter candidate gene: 2406xxxx
uplifted v7 positions: ~ 27713255.
I should make sure my region starts includes this.
Currently in *candidates.nooutliers.10mis.2DPhets.vcf, the first SNP is 27739292. 
Next: I will go back to *variants.candidates.vcf and try to find a good candidate a little earlier.

*variants.candidates.nooutliers.10mis starts at 27643909. So it's the DP threshold that is excluding  the earlier positions.



Let's revisit the F_MISSING threshold on the hets: 

bcftools view --exclude 'FORMAT/DP[@bighetrefs.txt] < 2' --output-type v introgress1.v7.variants.candidates.nooutliers.10mis.vcf | bcftools query -f '%POS %FORMAT/DP \n' | less -S
(first pos is 27739292; not early enough)


Try F_PASS:
bcftools view --include 'F_PASS(FORMAT/DP > 2) > 0.75' --output-type v introgress1.v7.variants.candidates.nooutliers.10mis.vcf | bcftools query -f '%POS %FORMAT/DP \n' | less -S

F_PASS to specific to het genotypes:
bcftools view --include 'F_PASS(FORMAT/DP[@bighetrefs.txt] > 1) > 0.5' --output-type v introgress1.v7.variants.candidates.nooutliers.10mis.vcf | bcftools query -f '%POS %FORMAT/DP \n' | less -S
(I don't think this is doing what I think it's doing because the threshold is very low and not many are getting through. Checking the filter:)

bcftools view --samples-file bighetrefs.txt --include 'N_PASS(FORMAT/DP[@bighetrefs.txt] > 2) > 21' --output-type v introgress1.v7.variants.candidates.nooutliers.10mis.vcf | bcftools query -f '%POS  [ %SAMPLE %AD ] \n'  | less
(this looks like it is working properly. There are 3 of 25 het samples that have a DP of 2 or less. so 22 pass, which is >21. This keeps the 27643909 site.)




N_PASS to specific to glaz genotypes:
bcftools view --include 'N_PASS(FORMAT/DP[@glaziovii_nooutliers.txt] > 2) > 4' --output-type v introgress1.v7.variants.candidates.nooutliers.10mis.vcf | bcftools query -f '%POS %FORMAT/DP \n' | less -S

Look at site 27643909:
4/5 glazioviis have a call there; plus all the hets have a call. Let's use that site.



bcftools view --include 'N_PASS(FORMAT/DP[@glaziovii_nooutliers.txt] > 2) > 4' --output-type v introgress1.v7.variants.candidates.nooutliers.10mis.vcf | bcftools query -f '%POS %FORMAT/DP \n' | less -S

bcftools view --include 'N_PASS(FORMAT/DP[@glaziovii_nooutliers.txt] > 2) > 4 & N_PASS(FORMAT/DP[@bighetrefs.txt] > 2) > 21' --output-type v introgress1.v7.variants.candidates.nooutliers.10mis.vcf | bcftools query -f '%POS %FORMAT/DP \n' | less -S
(not sure why nothing is coming through. && works. Will pipe and do the filters separately.)

bcftools view --include 'N_PASS(FORMAT/DP[@glaziovii_nooutliers.txt] > 2) > 4' --output-type v introgress1.v7.variants.candidates.nooutliers.10mis.vcf | bcftools view --include 'N_PASS(FORMAT/DP[@bighetrefs.txt] > 2) > 21' --output-type v | bcftools query -f '%POS %FORMAT/DP \n' | less -S
********* (this works.) ********


Counting sites in passing the N_PASS filter:
& N_PASS(FORMAT/DP[@bighetrefs.txt] > 2) > 21


##### 1/28/21 ########
bcftools view --include 'N_PASS(FORMAT/DP[@glaziovii_nooutliers.txt] > 2) > 4' --output-type v introgress1.v7.variants.candidates.nooutliers.10mis.vcf | bcftools view --include 'N_PASS(FORMAT/DP[@bighetrefs.txt] > 2) > 21' --output-type v --output-file introgress1.v7.variants.candidates.nooutliers.10mis.NPASS.vcf

#### 2/3/21 #####
Rename 'final' candidate list (exported to R) for clarity

cp introgress1.v7.variants.candidates.nooutliers.10mis.NPASS.vcf kasp.candidates.vcf


