---
title: "Seedling nursery phenotypes"
author: "Seren Villwock"
date: "7/6/2021"
output: html_document
---

```{r}
library(tidyverse)
setwd("~/Desktop/Research/Glaziovii_introgression/IITA_data_collection_seedling_nursery_2021/Data_backup/")

phenos = read.csv("master_SN_2021_phenotypes.csv")
samples = read.csv("../21.GS.C6.SN.Student2_plate_coordinates_fixed.csv")

# add a column to tell whether that plant was sampled for genotyping
phenos$genotyped <- phenos$plot_name %in% samples$tissue_id

write.csv(phenos, file="master_SN_2021_phenotypes_sampled.csv")

```

Rename columns & variable names with explicit trait names for Cassavabase:
```{r}
#note: I'm using grep because one of the fieldbook tablets had a space around the "cylindrical" or "compact" plant type names and the other didn't

#plants typed "umbrella" and any plants with branch type "B" (for basal) have basal branches.
#convert this to an explicit trait
phenos$basal_branches = FALSE
phenos$basal_branches[phenos$branch_type == "B"] <- TRUE
phenos$basal_branches[grep("Umbrella", phenos$branch_shape)] <- TRUE

#fill in the NA branch_types (left blank if plant was cylindrical/didn't branch)
phenos$branch_type[grep("Cylindrical", phenos$branch_shape)] <- 1

#wide branch angle
phenos$'open branch type' = FALSE
phenos$'open branch type'[grep("Open", phenos$branch_shape)] <- TRUE

# set broken stem default to false
phenos$broken_stem[phenos$broken_stem != TRUE] = FALSE


#rename traits
phenos$'branching habit visual observation 1-4   |CO_334:0000140' = phenos$branch_type
phenos$'presence of basal branches' = phenos$basal_branches
phenos$'basal stem diameter measurement in mm' = phenos$stem_diam
phenos$'plant height measurement in cm   |CO_334:0000018' = phenos$plant_height

phenos_to_upload = phenos %>% select(c(1,2,4,8,10,15,17:21))
write.csv(phenos_to_upload, file="./Data_backup/to_upload_to_CB/21.GS.C6.SN.Student2.IB_phenotypes.csv")
```



Removed missing plants at end of families (manual)
Saved as "master_SN_2021_phenotypes_sampled_clean.csv"















OLD:

```{r}

#height = read.csv("Data_backup/plant-height_master_fieldbook_layout_2021-06-29_13_29_45_21.GS.C6.SN.Student2.IB_table.csv")[, c(1,2,3,4,13,21)]
#height[1145,5] <- NA # remove outlier value 
#untagged = read.csv("Data_backup/missing_21.GS.C6.SN.Student2.IB.csv")[, c(3,10)]
#smith = read.csv("Data_backup/smith_june_data.csv")[,c(3,5,9,10,11)]
#living = height[!is.na(height[,5]),]
#nrow(height[!is.na(height[,5]),]) + nrow(untagged) #5031 living plants with height values
#3008 - 52 parents = 2956 to sample from the population (about 59% of the population)
#all = merge(height,smith, by=c("accession_name","plot_number"))



hist(height$plant.height.measurement.in.cm....CO_334.0000018, breaks=20, main="plant height variation", xlab="plant height in cm")
```




Arrange and merge all plate coordinate files:
```{r}
require("readxl")
require("tidyverse")

setwd("~/Desktop/Research/Glaziovii_introgression/IITA_data_collection_seedling_nursery_2021/Tissue_sampling/")
file_list <- list.files(path="~/Desktop/Research/Glaziovii_introgression/IITA_data_collection_seedling_nursery_2021/Tissue_sampling/", full.names=FALSE)

all_plates <- data.frame()

for (i in 1:length(file_list)){
  temp_data <- read.csv(file_list[i])
  all_plates <- rbind(all_plates, temp_data)
}

all_plates$plate_id = sub("(?i)plate ", "plate_", all_plates$plate_id) #fix spaces and case
all_plates$plate_name = gsub(" ", "_", all_plates$plate_name)
```

Line up with sample name:
```{r}
layout = read.csv("~/Desktop/Research/Glaziovii_introgression/IITA_data_collection_seedling_nursery_2021/Nursery_layouts_barcodes/Seren_SN/Layouts/21.GS.C6.SN.Student2.IB_layout_old.csv")[,1:3]
layout$plot_number = as.character(layout$plot_number)

missing.key = read.csv("~/Desktop/Research/Glaziovii_introgression/IITA_data_collection_seedling_nursery_2021/Nursery_layouts_barcodes/Seren_SN/Layouts/missing_21.GS.C6.SN.Student2.IB_table_updated-names.csv")

#make a column for the type of name listed as the tissue ID
all_plates$name_type[grepl("^TMS", all_plates$tissue_id)] = "acc.name"
all_plates$name_type[grepl("^21.GS.C6", all_plates$tissue_id)] = "full.name"
all_plates$name_type[grepl("^([0-9])+$", all_plates$tissue_id)] = "plot.num"
all_plates$name_type[grepl("BLANK", all_plates$tissue_id)] = "blank"
all_plates$name_type[c(2975,3065:3069)] = "full.name" #manually set wilds

#for each name type, find the associated full name and put it in a new column
for(i in 1:nrow(all_plates)){
  
  #look up by plot number; find associated full accession name
  if(all_plates$name_type[i] == "plot.num"){ 
    lookup = layout$plot_name[grep(paste0("^",all_plates$tissue_id[i],"$"), layout$plot_number)]
     if(length(lookup)!=0){
      all_plates$full_name[i] <- lookup
    } else{ 
      all_plates$full_name[i] <- all_plates$tissue_id[i]
        #print(paste0("error at ",i))
    }
  }
  
  #look up by accession name; fix the name if it's from the missing plants layout
  #the "missing" tag is also added to the parents (since they are not in main layout)
  if(all_plates$name_type[i] == "acc.name"){ 
    lookup = grep(all_plates$tissue_id[i], layout$plot_name, value=TRUE)
    if(length(lookup)!=0){
      all_plates$full_name[i] <- lookup
    } else{ 
      
      #check if it's in the missing names key
       lookup2 = grep(all_plates$tissue_id[i], missing.key$accession_name_old, value=F)
       
       if(length(lookup2)!=0){ 
         all_plates$full_name[i] <- 
         paste0("21.GS.C6.SN.Student2.IB-plantM-", missing.key$accession_name_new[lookup2]) }
        else{ 
      all_plates$full_name[i] <- paste0("21.GS.C6.SN.Student2.IB-plantM-",
                                          all_plates$tissue_id[i])}
      }
  }
  
  #leave it if it's already the full name or if it's a blank well
  if(all_plates$name_type[i] == "full.name" | all_plates$name_type[i] == "blank"){  
    all_plates$full_name[i] <- all_plates$tissue_id[i]
    }
}


#rename the tissue_id as the full accession name and save for exporting
all_plates_export = all_plates
all_plates_export$tissue_id <- all_plates_export$full_name 

setwd("~/Desktop/Research/Glaziovii_introgression/IITA_data_collection_seedling_nursery_2021/")
write.csv(all_plates_export[,1:11], "21.GS.C6.SN.Student2_plate_coordinates.csv")


```





























OLD
Tissue collection checking and plate range planning:

Wed. 7/7: 
collected 6 plates (564 samples) from plots 1 - 960. (edited 7/8: actually to plot 1000.)
Percentage collected first day:
```{r}
564 / nrow(living[living$plot_number <= 960,]) *100 
```
Left to collect:
```{r}
#remaining live plants
nrow(living[living$plot_number >= 960,])

#for remaining plate wells:
((32-6)*94)-52

#should be 57.9% of live plants.
(((32-6)*94)-52) / nrow(living[living$plot_number >= 960,])
```
Plate boundaries for Thursday 7/8:
```{r}
#6 plates = 6*94 = 564 samples to collect
#from:
564 / 0.579
# 974 plants = 974/6 = 162 per plate

leftoff = which(living$plot_number == 960) #where we left off plus 974 live plants
tail(living[leftoff:(leftoff+(162*1)),"plot_number"], n=1) #plots 960-1154 for plate 7
tail(living[leftoff:(leftoff+(162*2)),"plot_number"], n=1) #plots 1154-1333 for plate 8
tail(living[leftoff:(leftoff+(162*3)),"plot_number"], n=1) #plots 1333-1514 for plate 9

nrow(living[leftoff:(leftoff+(162*3)),])



tail(living[leftoff:(leftoff+(162*4)),"plot_number"], n=1) #plots 1514-1714 for plate 10
tail(living[leftoff:(leftoff+(162*5)),"plot_number"], n=1) #plots 1714-1927 for plate 11
tail(living[leftoff:(leftoff+(162*6)),"plot_number"], n=1) #plots 1927-2112 for plate 12



#for tomorrow: plots 961-2113
```


Thurs. 7/8: 
collected 6 plates (564 samples) from plots 1000 - 2159.

Left to collect:
```{r}
#remaining live plants
remaining.plts = nrow(living[living$plot_number > 2159,])

#for remaining plate wells:
remaining.wells = ((32-12)*94)-52 #minus parents

#should collect from 58.6% of remaining live plants.
percent.remain = remaining.wells / remaining.plts
percent.remain
```

Plate boundaries for Thursday 7/8:
```{r}
#number of live plants to be represented per plate:
94 / percent.remain #160.5

leftoff = which(living$plot_number == 2160) #where we left off
tail(living[leftoff:(leftoff+(160*1)),"plot_number"], n=1) #plots 2160-2337 for plate 13
tail(living[leftoff:(leftoff+(161*2)),"plot_number"], n=1) #plots 2338-2505 for plate 14
tail(living[leftoff:(leftoff+(160*3)),"plot_number"], n=1) #plots 2506-2695 for plate 15

tail(living[leftoff:(leftoff+(161*4)),"plot_number"], n=1) #plots 2696-2886 for plate 16
tail(living[leftoff:(leftoff+(160*5)),"plot_number"], n=1) #plots 2887-3065 for plate 17
tail(living[leftoff:(leftoff+(161*6)),"plot_number"], n=1) #plots 3065-3263 for plate 18



#for tomorrow: plots 961-2113
```

Plate boundaries for Monday 7/12:

Left to collect:
```{r}
#remaining live plants
remaining.plts = nrow(living[living$plot_number > 3469,])

#for remaining plate wells:
remaining.wells = ((32-19)*94)-56 #minus parents + glazioviis

#should collect from 58.7% of remaining live plants.
percent.remain = remaining.wells / remaining.plts
percent.remain
```


```{r}
#number of live plants to be represented per plate:
94 / percent.remain #160.1

leftoff = which(living$plot_number == 3450) #where we left off
tail(living[leftoff:(leftoff+(160*1)),"plot_number"], n=1) #plots 3450-3661 for plate 20
tail(living[leftoff:(leftoff+(160*2)),"plot_number"], n=1) #plots 3662-3871 for plate 21
tail(living[leftoff:(leftoff+(160*3)),"plot_number"], n=1) #plots 3872-4064 for plate 22
tail(living[leftoff:(leftoff+(160*4)),"plot_number"], n=1) #plots 4065-4280 for plate 23

tail(living[leftoff:(leftoff+(160*5)),"plot_number"], n=1) #plots 4281-4458 for plate 24
tail(living[leftoff:(leftoff+(160*6)),"plot_number"], n=1) #plots 4459-4679 for plate 25


tail(living[leftoff:(leftoff+(160*7)),"plot_number"], n=1) #plots 4680-4857 for plate 26
tail(living[leftoff:(leftoff+(160*8)),"plot_number"], n=1) #plots 4858-5050 for plate 27





#for tomorrow: plots 961-2113
```



Plate boundaries for Tuesday 7/13: Last day
Left to collect: plots 4680- end; 1 parent

```{r}
parents = read.table("~/Desktop/Research/Glaziovii_introgression/unique_parents_list.txt")[,1]
parents.sampled = read.csv("~/Downloads/parents_sampled.csv", header=F)[,1]
# missing parents:
setdiff(parents, parents.sampled)
```

Left to collect:
```{r}
#remaining live plants
remaining.plts = nrow(living[living$plot_number > 4679,])

#for remaining plate wells:
remaining.wells = ((32-25)*94)- (2+5+1+5) #minus homozygous parents + wilds + remaining parent + 5 from around plot 840-850)

#should collect from 58.7% of remaining live plants.
percent.remain = remaining.wells / remaining.plts
percent.remain
```


```{r}
#number of live plants to be represented per plate:
94 / percent.remain #155

leftoff = which(living$plot_number == 4680) #where we left off

tail(living[leftoff:(leftoff+(155*1)),"plot_number"], n=1) #plots 4680-4853 for plate 26
tail(living[leftoff:(leftoff+(155*2)),"plot_number"], n=1) #plots 4854-5040 for plate 27
tail(living[leftoff:(leftoff+(155*3)),"plot_number"], n=1) #plots 5041-5277 for plate 28

tail(living[leftoff:(leftoff+(155*4)),"plot_number"], n=1) #plots 5278-5464 for plate 29
tail(living[leftoff:(leftoff+(155*5)),"plot_number"], n=1) #plots 5465-5666 for plate 30
tail(living[leftoff:(leftoff+(155*6)),"plot_number"], n=1) #plots 5667-5866 for plate 31

tail(living[leftoff:(leftoff+(155*7)),"plot_number"], n=1) #plots 5867-6006 for plate 32
#should leave 1 row for wilds
#1 row for sampling 840-850 + remaining parent + TMEB419

nrow(living[which(living$plot_number > 5866),])

(2+5+1+5+1) 





#edited:
#plots 5667-5852 for plate 31
#should fill in column 12 with sampling 840-850 + remaining parent + TMEB419

#plots 5853-6006 for plate 32
#should leave column 12 for wilds

```


